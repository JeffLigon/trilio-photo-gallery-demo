
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trilio Photo Gallery Demo</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin:0; background:#f8fafc; color:#0f172a;}
    header { position:sticky; top:0; background:rgba(255,255,255,.9); backdrop-filter: blur(6px); border-bottom:1px solid #e2e8f0;}
    .container { max-width: 1100px; margin:0 auto; padding: 16px;}
    .brand { display:flex; align-items:center; gap:10px; font-weight:800;}
    .brand img { height:32px; }
    .actions { display:flex; gap:8px; }
    button { border-radius:16px; border:1px solid #e2e8f0; padding:8px 12px; background:white; cursor:pointer;}
    button.primary { background:#10b981; color:white; border-color:#10b981;}
    button.warn { color:#b91c1c; border-color:#fecaca; }
    button.info { color:#1d4ed8; border-color:#bfdbfe; }
    .hero { background: linear-gradient(90deg,#10b981,#0ea5e9); color:white;}
    .hero .container{ display:grid; grid-template-columns: 1fr 320px; gap:16px; align-items:center; }
    .tile { background:white; border-radius:16px; box-shadow:0 1px 6px rgba(2,6,23,.06); overflow:hidden;}
    .tile img { width:100%; height:180px; object-fit:cover; display:block;}
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; margin-top:16px;}
    .muted { color:#475569; font-size:12px; }
    .row { display:flex; justify-content:space-between; gap:8px; align-items:center;}
    .flash { position:fixed; top:72px; left:50%; transform:translateX(-50%); background:#0f172a; color:white; padding:8px 12px; border-radius:999px; box-shadow:0 10px 20px rgba(0,0,0,.2); }
    form.upload { display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  </style>
</head>
<body>
  <header>
    <div class="container row">
      <div class="brand">
        <img src="https://cdn-lmain.nitrocdn.com/VcQxMxVyPvNLHEmtKfmuCQDMOhYXBWgb/assets/images/optimized/rev-873c47a/trilio.io/wp-content/uploads/2023/04/logo2022.svg" alt="Trilio"/>
        <span>Photo Gallery Demo</span>
      </div>
      <div class="actions">
        <button id="btn-backup" class="primary">Take Backup</button>
        <button id="btn-disaster" class="warn">Simulate Disaster</button>
        <button id="btn-restore" class="info">Restore</button>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <div>
        <h1>Stateful App Demo — Instantly Visual</h1>
        <p>UI + MySQL. Images live on a PVC at <code>/data/media</code>. Metadata lives in MySQL (PVC). Use the buttons to back up, delete, and restore.</p>
        <form class="upload" id="upload-form">
          <input type="file" id="file" name="file" accept="image/*" required/>
          <input type="text" id="title" name="title" placeholder="Title" />
          <input type="text" id="caption" name="caption" placeholder="Caption" />
          <button type="submit">Upload</button>
        </form>
      </div>
      <div class="tile" style="padding:12px; color:white; background:rgba(255,255,255,.15)">
        <div class="row"><div class="muted">DB Rows</div><div id="dbrows" style="font-weight:800; font-size:24px">—</div></div>
        <div class="row"><div class="muted">Disk (MB)</div><div id="diskmb" style="font-weight:800; font-size:24px">—</div></div>
        <div class="row"><div class="muted">Last Backup</div><div id="lastbackup" style="font-weight:600;">—</div></div>
      </div>
    </div>
  </section>

  <div class="container">
    <div id="grid" class="grid"></div>
  </div>

  <div id="flash" class="flash" style="display:none;"></div>

  <script>
    const $ = (s)=>document.querySelector(s);
    let lastBackup = null;

    function flash(msg){ const f=$("#flash"); f.textContent=msg; f.style.display="block"; setTimeout(()=>f.style.display="none",1500); }
    function fmtMB(n){ return (n/1024/1024).toFixed(2); }

    async function refresh(){
      const res = await fetch('/api/photos');
      const items = await res.json();
      const grid = $("#grid"); grid.innerHTML = "";
      let total = 0;
      items.forEach(it=>{
        total += it.size_bytes||0;
        const card = document.createElement('div');
        card.className='tile';
        card.innerHTML = `
          <img src="${it.url}" alt="${it.title}" onerror="this.src='data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'640\\' height=\\'420\\'><rect width=\\'100%\\' height=\\'100%\\' fill=\\'lightgray\\'/><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\'>Image</text></svg>')}'" />
          <div style="padding:12px">
            <div style="font-weight:600">${it.title||'Untitled'}</div>
            <div class="muted">${it.caption||''}</div>
            <div class="row muted">
              <span>${fmtMB(it.size_bytes||0)} MB</span>
              <button data-id="${it.id}">Delete</button>
            </div>
          </div>`;
        card.querySelector('button').onclick = async () => {
          await fetch('/api/photos/'+it.id, { method:'DELETE' });
          flash('Deleted');
          refresh();
        };
        grid.appendChild(card);
      });
      $("#dbrows").textContent = items.length;
      $("#diskmb").textContent = fmtMB(total);
      $("#lastbackup").textContent = lastBackup ? (lastBackup.length + " items") : "—";
    }

    $("#upload-form").addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const res = await fetch('/api/upload', { method:'POST', body: fd });
      if (res.ok){ flash('Uploaded'); refresh(); } else { flash('Upload failed'); }
      e.target.reset();
    });

    $("#btn-backup").onclick = async ()=>{
      const res = await fetch('/api/photos'); lastBackup = await res.json(); flash('Backup completed');
      $("#lastbackup").textContent = lastBackup.length + " items";
    };
    $("#btn-disaster").onclick = async ()=>{
      const res = await fetch('/api/photos'); const items = await res.json();
      for (const it of items){ await fetch('/api/photos/'+it.id, { method:'DELETE' }); }
      flash('Disaster simulated');
      refresh();
    };
    $("#btn-restore").onclick = async ()=>{
      if (!lastBackup){ flash('No backup available'); return; }
      flash('Assume restore completed (use Trilio for real restore)');
      refresh();
    };

    refresh();
  </script>
</body>
</html>
